//
//  HomeScene.cpp
//  fancyHeart
//
//  Created by 秦亮亮 on 14-5-12.
//
//

#include "HomeScene.h"

HomeScene::HomeScene(){

}

HomeScene::~HomeScene(){

}

Scene* HomeScene::createScene(){
	auto scene = Scene::create();
    auto layer = HomeScene::create();
    scene->addChild(layer);
	return scene;
}
HomeScene* HomeScene::create()
{
    HomeScene* homeScene=new HomeScene();
    if (homeScene && homeScene->init("publish/HomeScene.json",true)) {
        homeScene->autorelease();
        return homeScene;
    }
    CC_SAFE_DELETE(homeScene);
    return nullptr;
}
void HomeScene::onEnter()
{
    BaseUI::onEnter();
}
bool HomeScene::init(std::string fileName,bool isScence){
	if(!BaseUI::init(fileName,isScence)){
		return false;
	}
    std::vector<std::string> buildNames;
    buildNames.push_back("img_hecheng");
    buildNames.push_back("img_tiaozhan");
    buildNames.push_back("img_hero");
    buildNames.push_back("img_shichang");
    buildNames.push_back("img_zhaohuan");
    buildNames.push_back("img_fuben");
    float designSizeWidth=1136;
    float desighHeight=640;
    Size size=Director::getInstance()->getOpenGLView()->getDesignResolutionSize();
    Size screenSize=Director::getInstance()->getOpenGLView()->getFrameSize();
    ComRender *render = static_cast<ComRender*>(layout->getChildByTag(10003)->getComponent("GUIComponent"));
    
    Layout *comLayout=static_cast<Layout*>(render->getNode());
    float scale=fmin(size.width/designSizeWidth,size.height/desighHeight);
    auto widget=static_cast<Widget*>(comLayout->getChildByName("home_top"));
    widget->setPosition(Vec2(size.width/2, (size.height-widget->getContentSize().height*scale/2)));
    widget->setScale(scale);
    
    widget=static_cast<Widget*>(comLayout->getChildByName("home_leftop"));
    widget->setPosition(Vec2(widget->getContentSize().width*scale/2, (size.height-widget->getContentSize().height*scale/2)));
    widget->setScale(scale);
    //
    
    widget=static_cast<Widget*>(comLayout->getChildByName("home_right"));
    widget->setPosition(Vec2(size.width-widget->getContentSize().width*scale/2, (size.height-widget->getContentSize().height*scale/2)));
    widget->setScale(scale);
    
    widget=static_cast<Widget*>(comLayout->getChildByName("home_build"));
    widget->setPosition(Vec2((size.width-widget->getContentSize().width*scale)/2, (size.height-widget->getContentSize().height)/2));
    widget->setScale(scale);
    for (size_t i=0; i<buildNames.size(); i++) {
        auto image=widget->getChildByName(buildNames.at(i).c_str());
        image->setTouchEnabled(true);
        image->addTouchEventListener(CC_CALLBACK_2(HomeScene::touchEvent, this));
    }

    
    
    widget=static_cast<Widget*>(comLayout->getChildByName("home_botom"));
    widget->setPosition(Vec2(size.width/2, 0+widget->getContentSize().height*scale/2));
    widget->setScale(scale);
    
    widget=comLayout->getChildByName("img_cloud");
    lrTuoyuanConfig c;
    c.aLength=c.aLength=size.width/2;
    
    c.centerPosition=Vec2(size.width/2, size.height/2);
    widget->runAction(CircleMove::actionWithDuration(10, c));
    
    //layout->addTouchEventListener(CC_CALLBACK_2(HomeScene::touchEvent, this));
    
//    srand((int)time(0));
//    log("==time:%ld",Utils::getTime());
	return true;
}

void HomeScene::touchEvent(cocos2d::Ref *pSender, TouchEventType type)
{
    auto sprite=static_cast<Sprite*>(pSender);
    if(!sprite)return;
    switch (type) {
        case TouchEventType::BEGAN:
            if (sprite->getTag()>=10001 && sprite->getTag()<=10006) {
                sprite->stopAllActions();
                sprite->runAction(Sequence::create(ScaleTo::create(0.15,1.1),ScaleTo::create(0.15, 1),NULL) );
            }
            break;
        case TouchEventType::MOVED:
            break;
        case TouchEventType::ENDED:
        {
                switch (sprite->getTag()) {
                    case 10001:
                    {
                        
                    }
                        break;
                    case 10002:
                    {
                        
                    }
                        break;
                    case 10003:
                    {
                        
                    }
                        break;
                    case 10004:
                    {
                        
                    }
                        break;
                    case 10005:
                    {
                        
                    }
                        break;
                    case 10006:
                    {
                        
                    }
                        break;
                    default:
                        break;
                }
            }
            
        
            break;
        case TouchEventType::CANCELED:
        
            break;
        default:
            break;
    }
}

void HomeScene::initNetEvent(){
    auto listener = EventListenerCustom::create(NET_MESSAGE, [=](EventCustom* event){
        NetMsg* msg = static_cast<NetMsg*>(event->getUserData());
        log("Custom event 1 received:%d,%d",msg->msgId,msg->len);
        switch (msg->msgId)
        {
            case C_LOGIN:
            {
                PackageLoginResp* pm=new PackageLoginResp();
                pm->ParseFromArray(msg->bytes, msg->len);
            }
                break;
            default:
                break;
        }
    });
    Director::getInstance()->getEventDispatcher()->addEventListenerWithFixedPriority(listener,1);
}